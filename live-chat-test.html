<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .chat-container { display: flex; gap: 20px; margin-top: 20px; }
        .chat-box { flex: 1; border: 1px solid #ccc; border-radius: 8px; padding: 15px; height: 400px; }
        .chat-messages { height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; }
        .message { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .user-message { background: #D1FAE5; text-align: right; }
        .admin-message { background: #DBEAFE; text-align: left; }
        .system-message { background: #FEF3C7; text-align: center; font-style: italic; }
        .chat-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .send-btn { background: #4F46E5; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; }
        .send-btn:hover { background: #4338CA; }
        .status { padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .connected { background: #D1FAE5; border: 1px solid #10B981; }
        .disconnected { background: #FEE2E2; border: 1px solid #EF4444; }
        .connecting { background: #FEF3C7; border: 1px solid #F59E0B; }
        button { background: #4F46E5; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        button:hover { background: #4338CA; }
        .result { margin-top: 20px; padding: 15px; border-radius: 4px; }
        .success { background: #D1FAE5; border: 1px solid #10B981; }
        .error { background: #FEE2E2; border: 1px solid #EF4444; }
        .info { background: #DBEAFE; border: 1px solid #3B82F6; }
    </style>
</head>
<body>
    <h1>Live Chat Test</h1>
    <p>This test verifies real-time chat functionality between users and admin.</p>
    
    <!-- Connection Status -->
    <div class="test-section">
        <h2>Connection Status</h2>
        <div id="connectionStatus" class="status connecting">Connecting...</div>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="disconnectAll()">Disconnect All</button>
        <div id="connectionResult"></div>
    </div>
    
    <!-- Chat Test -->
    <div class="test-section">
        <h2>Live Chat Test</h2>
        <p>Test real-time messaging between user and admin.</p>
        
        <div class="chat-container">
            <!-- User Chat -->
            <div class="chat-box">
                <h3>User Chat</h3>
                <div id="userStatus" class="status connecting">Connecting...</div>
                <div id="userMessages" class="chat-messages"></div>
                <input type="text" id="userInput" class="chat-input" placeholder="Type a message as user..." onkeydown="handleUserMessage(event)">
                <button class="send-btn" onclick="sendUserMessage()">Send</button>
            </div>
            
            <!-- Admin Chat -->
            <div class="chat-box">
                <h3>Admin Chat</h3>
                <div id="adminStatus" class="status connecting">Connecting...</div>
                <div id="adminMessages" class="chat-messages"></div>
                <input type="text" id="adminInput" class="chat-input" placeholder="Type a message as admin..." onkeydown="handleAdminMessage(event)">
                <button class="send-btn" onclick="sendAdminMessage()">Send</button>
            </div>
        </div>
        
        <div id="chatResult"></div>
    </div>
    
    <!-- Notification Test -->
    <div class="test-section">
        <h2>Chat Notification Test</h2>
        <button onclick="testUserNotification()">Test User Chat Notification</button>
        <button onclick="testDashboardNotification()">Test Dashboard Chat Notification</button>
        <button onclick="testLiveChatNotification()">Test Live Chat Notification</button>
        <div id="notificationResult"></div>
    </div>
    
    <!-- Message History Test -->
    <div class="test-section">
        <h2>Message History Test</h2>
        <button onclick="testMessageStorage()">Test Message Storage</button>
        <button onclick="loadMessageHistory()">Load Message History</button>
        <div id="historyResult"></div>
    </div>

    <script>
        let userSocket, adminSocket;
        let userConnected = false, adminConnected = false;
        let messageHistory = [];
        
        // Initialize connections
        function initializeConnections() {
            const backendUrl = window.location.hostname === 'localhost' ? 'http://localhost:4000' : 'https://frosstbank-backend.onrender.com';
            
            // User connection
            userSocket = io(backendUrl);
            userSocket.on('connect', () => {
                userConnected = true;
                document.getElementById('userStatus').className = 'status connected';
                document.getElementById('userStatus').textContent = 'Connected as User';
                userSocket.emit('join', { userId: 'test-user-' + Date.now() });
                addUserMessage('Connected to chat server', 'system');
            });
            
            userSocket.on('disconnect', () => {
                userConnected = false;
                document.getElementById('userStatus').className = 'status disconnected';
                document.getElementById('userStatus').textContent = 'Disconnected';
            });
            
            userSocket.on('message', (message) => {
                addUserMessage(message.content, 'admin');
            });
            
            // Admin connection
            adminSocket = io(backendUrl);
            adminSocket.on('connect', () => {
                adminConnected = true;
                document.getElementById('adminStatus').className = 'status connected';
                document.getElementById('adminStatus').textContent = 'Connected as Admin';
                adminSocket.emit('join', { userId: 'admin' });
                addAdminMessage('Connected to chat server', 'system');
            });
            
            adminSocket.on('disconnect', () => {
                adminConnected = false;
                document.getElementById('adminStatus').className = 'status disconnected';
                document.getElementById('adminStatus').textContent = 'Disconnected';
            });
            
            adminSocket.on('message', (message) => {
                addAdminMessage(message.content, 'user');
            });
            
            adminSocket.on('chatNotification', (notification) => {
                addAdminMessage(`New chat notification: ${notification.type} from ${notification.userName}`, 'system');
            });
            
            // Update connection status
            updateConnectionStatus();
        }
        
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            if (userConnected && adminConnected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = 'Both connections active';
            } else if (userConnected || adminConnected) {
                statusDiv.className = 'status connecting';
                statusDiv.textContent = 'Partial connection';
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = 'No connections';
            }
        }
        
        // Test connection
        function testConnection() {
            const resultDiv = document.getElementById('connectionResult');
            
            if (userConnected && adminConnected) {
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>✅ Connection Test Successful</h3>
                        <p>Both user and admin are connected to the chat server</p>
                        <p>User Socket ID: ${userSocket.id}</p>
                        <p>Admin Socket ID: ${adminSocket.id}</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Connection Test Failed</h3>
                        <p>User connected: ${userConnected}</p>
                        <p>Admin connected: ${adminConnected}</p>
                    </div>
                `;
            }
        }
        
        // Disconnect all
        function disconnectAll() {
            if (userSocket) userSocket.disconnect();
            if (adminSocket) adminSocket.disconnect();
            userConnected = false;
            adminConnected = false;
            updateConnectionStatus();
        }
        
        // User message handling
        function handleUserMessage(event) {
            if (event.key === 'Enter') {
                sendUserMessage();
            }
        }
        
        function sendUserMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (message && userConnected) {
                addUserMessage(message, 'user');
                
                // Send to admin
                userSocket.emit('message', {
                    from: 'test-user',
                    to: 'admin',
                    content: message,
                    timestamp: new Date().toISOString()
                });
                
                // Store in history
                messageHistory.push({
                    from: 'user',
                    content: message,
                    timestamp: new Date().toISOString()
                });
                
                input.value = '';
            }
        }
        
        function addUserMessage(content, type) {
            const messagesDiv = document.getElementById('userMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Admin message handling
        function handleAdminMessage(event) {
            if (event.key === 'Enter') {
                sendAdminMessage();
            }
        }
        
        function sendAdminMessage() {
            const input = document.getElementById('adminInput');
            const message = input.value.trim();
            
            if (message && adminConnected) {
                addAdminMessage(message, 'admin');
                
                // Send to user
                adminSocket.emit('message', {
                    from: 'admin',
                    to: 'test-user',
                    content: message,
                    timestamp: new Date().toISOString()
                });
                
                // Store in history
                messageHistory.push({
                    from: 'admin',
                    content: message,
                    timestamp: new Date().toISOString()
                });
                
                input.value = '';
            }
        }
        
        function addAdminMessage(content, type) {
            const messagesDiv = document.getElementById('adminMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Notification tests
        function testUserNotification() {
            if (adminConnected) {
                adminSocket.emit('chatNotification', {
                    type: 'signup',
                    userId: 'test-user-' + Date.now(),
                    userName: 'Test User',
                    userAccount: 'TEST001',
                    timestamp: new Date().toISOString()
                });
                
                document.getElementById('notificationResult').innerHTML = `
                    <div class="success">
                        <h3>✅ User Notification Sent</h3>
                        <p>Chat notification sent to admin</p>
                    </div>
                `;
            }
        }
        
        function testDashboardNotification() {
            if (adminConnected) {
                adminSocket.emit('chatNotification', {
                    type: 'dashboard',
                    userId: 'test-user-' + Date.now(),
                    userName: 'Dashboard User',
                    userAccount: 'DASH001',
                    timestamp: new Date().toISOString()
                });
                
                document.getElementById('notificationResult').innerHTML = `
                    <div class="success">
                        <h3>✅ Dashboard Notification Sent</h3>
                        <p>Dashboard chat notification sent to admin</p>
                    </div>
                `;
            }
        }
        
        function testLiveChatNotification() {
            if (adminConnected) {
                adminSocket.emit('chatNotification', {
                    type: 'livechat',
                    userId: 'test-user-' + Date.now(),
                    userName: 'Live Chat User',
                    userAccount: 'LIVE001',
                    timestamp: new Date().toISOString()
                });
                
                document.getElementById('notificationResult').innerHTML = `
                    <div class="success">
                        <h3>✅ Live Chat Notification Sent</h3>
                        <p>Live chat notification sent to admin</p>
                    </div>
                `;
            }
        }
        
        // Message history tests
        function testMessageStorage() {
            const resultDiv = document.getElementById('historyResult');
            
            if (messageHistory.length > 0) {
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>✅ Message Storage Test</h3>
                        <p>${messageHistory.length} messages stored in memory</p>
                        <p>Last message: ${messageHistory[messageHistory.length - 1].content}</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="info">
                        <h3>ℹ️ Message Storage Test</h3>
                        <p>No messages stored yet. Send some messages first.</p>
                    </div>
                `;
            }
        }
        
        function loadMessageHistory() {
            const resultDiv = document.getElementById('historyResult');
            
            if (messageHistory.length > 0) {
                let html = `
                    <div class="info">
                        <h3>📋 Message History</h3>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
                `;
                
                messageHistory.forEach((msg, index) => {
                    html += `
                        <div style="margin: 5px 0; padding: 5px; background: ${msg.from === 'user' ? '#D1FAE5' : '#DBEAFE'}; border-radius: 4px;">
                            <strong>${msg.from}:</strong> ${msg.content}
                            <br><small>${new Date(msg.timestamp).toLocaleTimeString()}</small>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                resultDiv.innerHTML = html;
            } else {
                resultDiv.innerHTML = `
                    <div class="info">
                        <h3>ℹ️ No Message History</h3>
                        <p>Send some messages to see the history.</p>
                    </div>
                `;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeConnections();
        });
    </script>
</body>
</html> 