<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Frosst Bank</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    /* Mobile menu styles */
    .mobile-menu-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 40;
    }
    
    .mobile-menu-overlay.active {
      display: block;
    }
    
    .sidebar {
      transition: transform 0.3s ease-in-out;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 50;
        transform: translateX(-100%);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
    }
    
    /* Responsive table */
    @media (max-width: 768px) {
      .table-container {
        overflow-x: auto;
      }
      
      .user-table {
        min-width: 600px;
      }
      
      .user-card {
        display: block;
      }
      
      .user-table {
        display: none;
      }
    }
    
    /* Mobile-friendly form layouts */
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Mobile Menu Toggle -->
  <div class="md:hidden fixed top-4 left-4 z-50">
    <button id="mobileMenuToggle" class="bg-indigo-900 text-white p-2 rounded-md">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
  </div>

  <!-- Mobile Menu Overlay -->
  <div id="mobileMenuOverlay" class="mobile-menu-overlay"></div>

  <!-- Sidebar -->
  <div class="flex h-screen">
    <aside id="sidebar" class="sidebar w-64 bg-indigo-900 text-white p-5">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-bold">Bank Admin</h2>
        <button id="closeSidebar" class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <nav class="flex flex-col space-y-4">
        <a href="#create" class="hover:text-indigo-300 py-2 px-3 rounded hover:bg-indigo-800 transition-colors">Create User</a>
        <a href="#users" class="hover:text-indigo-300 py-2 px-3 rounded hover:bg-indigo-800 transition-colors">Manage Users</a>
        <a href="#chat" class="hover:text-indigo-300 py-2 px-3 rounded hover:bg-indigo-800 transition-colors relative">
          Live Chat
          <span id="chatNotification" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">1</span>
        </a>
        <a href="#transfers" class="hover:text-indigo-300 py-2 px-3 rounded hover:bg-indigo-800 transition-colors relative">
          Transfer Requests
          <span id="transferNotification" class="hidden absolute -top-1 -right-1 bg-orange-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">1</span>
        </a>
      </nav>
      
      <!-- Admin Info and Logout -->
      <div class="mt-auto pt-8 border-t border-indigo-700">
        <div class="flex items-center space-x-3 mb-4">
          <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center">
            <span class="text-white font-bold">A</span>
          </div>
          <div>
            <div class="text-sm font-medium">Admin User</div>
            <div class="text-xs text-indigo-300">admin123@frosstbank.com</div>
          </div>
        </div>
        <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded text-sm transition-colors">
          Logout
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content flex-1 p-4 md:p-8 overflow-y-scroll">
      
      <!-- Create User -->
      <section id="create" class="mb-10">
        <h2 class="text-xl font-bold mb-4">Create New User</h2>
        <form class="bg-white p-4 md:p-6 rounded shadow space-y-4" onsubmit="createUser(event)">
          <div class="form-grid grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="newName" placeholder="Full Name" class="w-full border p-2 rounded" required>
            <input type="email" id="newEmail" placeholder="Email Address" class="w-full border p-2 rounded" required>
            <input type="password" id="newPassword" placeholder="Password" class="w-full border p-2 rounded" required>
            <input type="text" id="newAccount" placeholder="Account Number" class="w-full border p-2 rounded" required>
            <input type="number" id="newBalance" placeholder="Initial Balance" class="w-full border p-2 rounded" required>
          </div>

          <!-- Drag-and-Drop Upload -->
          <div id="dropZone" class="border-2 border-dashed border-gray-400 rounded p-4 text-center cursor-pointer">
            <p class="text-sm md:text-base">Drag & drop profile image here or click to upload</p>
            <input type="file" id="newPictureFile" accept="image/*" class="hidden">
          </div>
          <img id="previewImg" src="" alt="Preview" class="h-20 w-20 rounded-full mx-auto hidden" />

          <button type="submit" class="w-full md:w-auto bg-indigo-700 text-white px-4 py-2 rounded hover:bg-indigo-800 transition-colors">Create User</button>
        </form>
      </section>

      <!-- User List -->
      <section id="users" class="mb-10">
        <h2 class="text-xl font-bold mb-4">Manage Users</h2>
        
        <!-- Search and Filter Controls -->
        <div class="bg-white p-4 rounded shadow mb-4">
          <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
            <div class="flex-1 w-full">
              <input type="text" id="searchUsers" placeholder="Search by name, email, or account..." 
                     class="w-full border p-2 rounded" onkeyup="filterUsers()">
            </div>
            <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
              <select id="sortUsers" class="border p-2 rounded w-full md:w-auto">
                <option value="name">Sort by Name</option>
                <option value="balance">Sort by Balance</option>
                <option value="account">Sort by Account</option>
              </select>
              <button onclick="exportUsers()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors w-full md:w-auto">
                Export Users
              </button>
            </div>
          </div>
        </div>

        <!-- Desktop Table -->
        <div class="table-container bg-white shadow rounded overflow-hidden">
          <table class="user-table w-full">
            <thead>
              <tr class="bg-gray-100 text-left">
                <th class="p-3">Photo</th>
                <th class="p-3">Name</th>
                <th class="p-3">Email</th>
                <th class="p-3">Account</th>
                <th class="p-3">Balance ($)</th>
                <th class="p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="userTable">
              <!-- Dynamically filled -->
            </tbody>
          </table>
          
          <!-- Mobile User Cards -->
          <div id="userCards" class="user-card p-4 space-y-4">
            <!-- Mobile user cards will be generated here -->
          </div>
          
          <div id="noUsersMessage" class="hidden p-8 text-center text-gray-500">
            No users found matching your search criteria.
          </div>
        </div>
        
        <!-- User Statistics -->
        <div class="mt-4 stats-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="bg-white p-4 rounded shadow">
            <div class="text-2xl font-bold text-blue-600" id="totalUsers">0</div>
            <div class="text-sm text-gray-600">Total Users</div>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <div class="text-2xl font-bold text-green-600" id="totalBalance">$0.00</div>
            <div class="text-sm text-gray-600">Total Balance</div>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <div class="text-2xl font-bold text-purple-600" id="avgBalance">$0.00</div>
            <div class="text-sm text-gray-600">Average Balance</div>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <div class="text-2xl font-bold text-orange-600" id="highBalanceUsers">0</div>
            <div class="text-sm text-gray-600">Users > $10k</div>
          </div>
        </div>
      </section>

      <!-- Transfer Requests -->
      <section id="transfers" class="mb-10">
        <h2 class="text-xl font-bold mb-4">Transfer Requests</h2>
        <div class="bg-white rounded shadow p-4 md:p-6">
          <div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="flex flex-col sm:flex-row gap-2">
              <button onclick="loadTransferRequests()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors">Refresh</button>
              <button onclick="exportTransfers()" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors">Export</button>
            </div>
            <div class="text-sm text-gray-600">
              <span id="transferStats">Loading...</span>
            </div>
          </div>
          <div class="space-y-4" id="transferRequests">
            <!-- Transfer requests will be loaded here dynamically -->
          </div>
        </div>
      </section>

      <!-- Live Chat -->
      <section id="chat">
        <h2 class="text-xl font-bold mb-4">
          Live Chat with Users
          <div class="flex flex-wrap gap-2 mt-2">
            <span id="signupChatIndicator" class="hidden bg-blue-500 text-white px-2 py-1 rounded text-xs">Sign-up Chat Active</span>
            <span id="dashboardChatIndicator" class="hidden bg-green-500 text-white px-2 py-1 rounded text-xs">Dashboard Chat Active</span>
            <span id="liveChatIndicator" class="hidden bg-purple-500 text-white px-2 py-1 rounded text-xs">Live Chat Active</span>
            <span id="transferChatIndicator" class="hidden bg-orange-500 text-white px-2 py-1 rounded text-xs">Transfer Chat Active</span>
          </div>
        </h2>
        <div class="mb-4 flex flex-wrap gap-2">
          <button onclick="testSignupChat()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors">Test Sign-up Chat</button>
          <button onclick="testDashboardChat()" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors">Test Dashboard Chat</button>
          <button onclick="testLiveChat()" class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600 transition-colors">Test Live Chat</button>
          <button onclick="testTransferChat()" class="bg-orange-500 text-white px-3 py-1 rounded text-sm hover:bg-orange-600 transition-colors">Test Transfer Chat</button>
        </div>
        
        <!-- Chat Source Selector -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Active Chat Sessions:</label>
          <div id="activeChats" class="space-y-2">
            <!-- Active chat sessions will be listed here -->
          </div>
        </div>

        <div class="bg-white rounded shadow h-80 md:h-96 p-4 flex flex-col">
          <div class="flex-1 overflow-y-auto mb-4" id="chatBox">
            <!-- Chat messages go here -->
            <div class="mb-2 text-left text-gray-800">
              <span class="bg-gray-100 px-3 py-2 rounded inline-block text-sm">
                <strong>System:</strong> Welcome to the unified chat system. You can now communicate with users from all pages.
              </span>
            </div>
          </div>
          <div class="flex">
            <input type="text" id="chatInput" class="flex-1 border p-2 rounded-l text-sm" placeholder="Type a message...">
            <button onclick="sendMessage()" class="bg-indigo-700 text-white px-4 py-2 rounded-r hover:bg-indigo-800 transition-colors">Send</button>
          </div>
        </div>
      </section>

      <!-- Manage Transactions -->
      <section id="transactions" class="mb-10">
        <h2 class="text-xl font-bold mb-4">Manage Transactions</h2>
        <div class="bg-white p-4 md:p-6 rounded shadow mb-4">
          <form id="addTransactionForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
            <input type="text" id="txUserAccount" placeholder="User Account #" class="border p-2 rounded" required>
            <input type="text" id="txDescription" placeholder="Description" class="border p-2 rounded" required>
            <input type="number" id="txAmount" placeholder="Amount" step="0.01" class="border p-2 rounded" required>
            <button type="submit" class="bg-indigo-700 text-white px-4 py-2 rounded hover:bg-indigo-800 transition-colors">Add Transaction</button>
          </form>
        </div>

        <div class="bg-white shadow rounded overflow-hidden">
          <div class="table-container">
            <table class="w-full">
              <thead>
                <tr class="bg-gray-100 text-left">
                  <th class="p-2 md:p-3 text-xs md:text-sm">User</th>
                  <th class="p-2 md:p-3 text-xs md:text-sm">Date</th>
                  <th class="p-2 md:p-3 text-xs md:text-sm">Description</th>
                  <th class="p-2 md:p-3 text-xs md:text-sm">Amount</th>
                  <th class="p-2 md:p-3 text-xs md:text-sm">Status</th>
                  <th class="p-2 md:p-3 text-xs md:text-sm">Actions</th>
                </tr>
              </thead>
              <tbody id="transactionTable">
                <!-- Dynamically filled -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white p-4 md:p-6 rounded-lg w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Edit User</h3>
        <button onclick="closeEdit()" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
          <input type="text" id="editName" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
          <input type="email" id="editEmail" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Account Number</label>
          <input type="text" id="editAccount" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Balance</label>
          <input type="number" id="editBalance" step="0.01" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Profile Picture URL</label>
          <input type="url" id="editPicture" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://..." />
        </div>
      </div>
      
      <div class="flex flex-col sm:flex-row gap-2 mt-6">
        <button onclick="closeEdit()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded transition-colors">Cancel</button>
        <button onclick="saveEdit()" class="flex-1 bg-indigo-700 hover:bg-indigo-800 text-white px-4 py-2 rounded transition-colors">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- JS Logic -->
  <script>
    // Check if admin is authenticated
    function checkAuth() {
      const token = localStorage.getItem('jwtToken');
      if (!token) {
        window.location.href = 'login.html';
        return null;
      }
      return token;
    }

    // Get admin info from JWT token
    function getAdminInfo() {
      const userInfo = localStorage.getItem('userInfo');
      if (!userInfo) {
        window.location.href = 'login.html';
        return null;
      }
      const user = JSON.parse(userInfo);
      if (user.role !== 'admin') {
        window.location.href = 'dashboard.html';
        return null;
      }
      return user;
    }

    // API helper function
    async function apiCall(endpoint, options = {}) {
      const token = checkAuth();
      if (!token) return null;

      const backendUrl = window.location.hostname === 'localhost' ? 'http://localhost:4000' : 'https://trial-1-sq1y.onrender.com';
      const response = await fetch(`${backendUrl}/api${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        }
      });

      if (response.status === 401) {
        localStorage.removeItem('jwtToken');
        localStorage.removeItem('userInfo');
        window.location.href = 'login.html';
        return null;
      }

      return response.json();
    }

    // Initialize with empty arrays (will be populated from API)
    let users = [];
    let uploadedImgURL = "";
    let chatActive = false;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Check if admin is logged in
      const admin = getAdminInfo();
      if (!admin) return;

      // Load data from backend
      loadUsers();
      loadTransactions();
      loadTransferRequests();
      updateActiveChatsDisplay();
      initializeSocket(); // Initialize Socket.io
      
      // Add chat input event listener
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            sendMessage();
          }
        });
      }

      // Mobile menu toggle
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const sidebar = document.getElementById('sidebar');
      const closeSidebar = document.getElementById('closeSidebar');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');

      if (mobileMenuToggle && sidebar && closeSidebar && mobileMenuOverlay) {
        mobileMenuToggle.addEventListener('click', () => {
          sidebar.classList.add('active');
          mobileMenuOverlay.classList.add('active');
        });

        closeSidebar.addEventListener('click', () => {
          sidebar.classList.remove('active');
          mobileMenuOverlay.classList.remove('active');
        });

        mobileMenuOverlay.addEventListener('click', (e) => {
          if (e.target === mobileMenuOverlay) {
            sidebar.classList.remove('active');
            mobileMenuOverlay.classList.remove('active');
          }
        });
      }
    });

    // Load users from backend API
    async function loadUsers() {
      try {
        console.log('Loading users from API...');
        users = await apiCall('/users') || [];
        console.log('Loaded users:', users);
        renderUsers();
        updateUserStatistics();
      } catch (error) {
        console.error('Error loading users:', error);
        showNotification(`Error loading users: ${error.message || 'Unknown error'}`, 'error');
      }
    }

    // Load transactions from backend API
    async function loadTransactions() {
      try {
        const transactions = await apiCall('/transactions') || [];
        renderTransactions(transactions);
      } catch (error) {
        console.error('Error loading transactions:', error);
        showNotification('Error loading transactions', 'error');
      }
    }

    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("newPictureFile");
    const previewImg = document.getElementById("previewImg");

    dropZone.addEventListener("click", () => fileInput.click());
    dropZone.addEventListener("dragover", (e) => e.preventDefault());
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      handleImageUpload(file);
    });

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      handleImageUpload(file);
    });

    function handleImageUpload(file) {
      if (!file.type.startsWith('image/')) {
        alert('Please upload an image file.');
        return;
      }
      
      // Compress image to reduce payload size
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const img = new Image();
      
      img.onload = function() {
        // Set canvas size (max 200x200 for profile pictures)
        const maxSize = 200;
        let width = img.width;
        let height = img.height;
        
        if (width > height) {
          if (width > maxSize) {
            height = (height * maxSize) / width;
            width = maxSize;
          }
        } else {
          if (height > maxSize) {
            width = (width * maxSize) / height;
            height = maxSize;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        
        // Draw and compress image
        ctx.drawImage(img, 0, 0, width, height);
        uploadedImgURL = canvas.toDataURL('image/jpeg', 0.7); // Compress to 70% quality
        previewImg.src = uploadedImgURL;
        previewImg.classList.remove("hidden");
      };
      
      img.src = URL.createObjectURL(file);
    }

    async function createUser(event) {
      event.preventDefault();
      const name = document.getElementById('newName').value;
      const email = document.getElementById('newEmail').value;
      const password = document.getElementById('newPassword').value;
      const account = document.getElementById('newAccount').value;
      const balance = parseFloat(document.getElementById('newBalance').value) || 0;
      const profilePicture = uploadedImgURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=${getRandomColor()}&color=fff&size=40`;

      // Validate inputs
      if (!name || !email || !password || !account) {
        alert('Please fill in all required fields.');
        return;
      }

      // Validate password
      if (password.length < 6) {
        alert('Password must be at least 6 characters long.');
        return;
      }

      try {
        // Create user via API
        const newUser = await apiCall('/users', {
          method: 'POST',
          body: JSON.stringify({
            name,
            email,
            password: password,
            account,
            role: 'user',
            profilePicture
          })
        });

        if (newUser) {
          // Add initial balance as a transaction
          if (balance > 0) {
            await apiCall('/transactions', {
              method: 'POST',
              body: JSON.stringify({
                user: newUser.id,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString(),
                description: 'Initial deposit',
                category: 'Deposit',
                amount: balance,
                status: 'completed'
              })
            });
          }

          showNotification('User created successfully!', 'success');
          loadUsers(); // Reload users
          loadTransactions(); // Reload transactions
        }
      } catch (error) {
        console.error('Error creating user:', error);
        showNotification('Error creating user', 'error');
      }

      // Reset form
      event.target.reset();
      previewImg.classList.add("hidden");
      uploadedImgURL = "";
    }

    function getRandomColor() {
      const colors = ['4F46E5', '059669', 'DC2626', '7C3AED', 'EA580C', 'BE185D', '0891B2', '16A34A'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    function renderUsers(userList = users) {
      const tbody = document.getElementById('userTable');
      const userCards = document.getElementById('userCards');
      const noUsersMessage = document.getElementById('noUsersMessage');
      
      if (!tbody) return;
      
      if (userList.length === 0) {
        tbody.innerHTML = '';
        userCards.innerHTML = ''; // Clear mobile cards
        if (noUsersMessage) noUsersMessage.classList.remove('hidden');
        return;
      }
      
      if (noUsersMessage) noUsersMessage.classList.add('hidden');
      tbody.innerHTML = '';
      userCards.innerHTML = ''; // Clear mobile cards

      userList.forEach((user, index) => {
        const row = `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-3"><img src="${user.profilePicture || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=4F46E5&color=fff&size=40`}" class="h-10 w-10 rounded-full" alt="${user.name}" /></td>
            <td class="p-3 font-medium">${user.name}</td>
            <td class="p-3 text-gray-600">${user.email}</td>
            <td class="p-3 font-mono text-sm">${user.account}</td>
            <td class="p-3 font-bold text-green-600">$${user.balance ? user.balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'}</td>
            <td class="p-3">
              <div class="flex space-x-2">
                <button onclick="openEdit('${user.id}')" class="text-indigo-600 hover:text-indigo-800 font-medium">Edit</button>
                <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-800 font-medium">Delete</button>
              </div>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;

        const mobileCard = `
          <div class="bg-white p-4 rounded-lg shadow-md flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <img src="${user.profilePicture || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=4F46E5&color=fff&size=40`}" alt="${user.name}" class="h-12 w-12 rounded-full">
              <div>
                <h3 class="font-semibold text-lg">${user.name}</h3>
                <p class="text-sm text-gray-600">${user.email}</p>
                <p class="text-sm text-gray-600">Account: ${user.account}</p>
                <p class="text-sm text-gray-600">Balance: $${user.balance ? user.balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'}</p>
              </div>
            </div>
            <div class="flex space-x-2">
              <button onclick="openEdit('${user.id}')" class="text-indigo-600 hover:text-indigo-800 font-medium">Edit</button>
              <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-800 font-medium">Delete</button>
            </div>
          </div>
        `;
        userCards.innerHTML += mobileCard;
      });
      
      updateUserStatistics();
    }

    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      
      console.log('Attempting to delete user with ID:', userId);
      console.log('User ID type:', typeof userId);
      console.log('Current users array:', users);
      
      try {
        const result = await apiCall(`/users/${userId}`, { method: 'DELETE' });
        console.log('Delete result:', result);
        showNotification('User deleted successfully!', 'success');
        loadUsers();
      } catch (error) {
        console.error('Error deleting user:', error);
        console.error('Error details:', error);
        showNotification(`Error deleting user: ${error.message || 'Unknown error'}`, 'error');
      }
    }

    let currentEditIndex = null;
    async function openEdit(userId) {
      console.log('Attempting to edit user with ID:', userId);
      console.log('User ID type:', typeof userId);
      console.log('Available users:', users);
      
      currentEditIndex = userId;
      const user = users.find(u => u.id === userId);
      
      console.log('User found by ID:', user);
      console.log('User ID comparison check:');
      users.forEach(u => {
        console.log(`User ${u.id} (${typeof u.id}) === ${userId} (${typeof userId}): ${u.id === userId}`);
      });
      
      if (!user) {
        console.error('User not found with ID:', userId);
        showNotification('User not found', 'error');
        return;
      }

      console.log('Found user for editing:', user);

      document.getElementById('editName').value = user.name;
      document.getElementById('editEmail').value = user.email;
      document.getElementById('editAccount').value = user.account;
      document.getElementById('editBalance').value = user.balance || 0;
      document.getElementById('editPicture').value = user.profilePicture || '';
      document.getElementById('editModal').classList.remove('hidden');
      document.getElementById('editModal').classList.add('flex');
    }

    function closeEdit() {
      document.getElementById('editModal').classList.add('hidden');
      currentEditIndex = null;
    }

    async function saveEdit() {
      const name = document.getElementById('editName').value;
      const email = document.getElementById('editEmail').value;
      const account = document.getElementById('editAccount').value;
      const balance = parseFloat(document.getElementById('editBalance').value) || 0;
      const profilePicture = document.getElementById('editPicture').value || `https://via.placeholder.com/40/${getRandomColor()}/FFFFFF?text=${name.split(' ').map(n => n[0]).join('')}`;

      // Validate inputs
      if (!name || !email || !account) {
        alert('Please fill in all required fields.');
        return;
      }

      console.log('Attempting to update user with ID:', currentEditIndex);
      console.log('User ID type:', typeof currentEditIndex);
      console.log('Update data:', { name, email, account, profilePicture });

      try {
        const result = await apiCall(`/users/${currentEditIndex}`, {
          method: 'PUT',
          body: JSON.stringify({
            name,
            email,
            account,
            profilePicture
          })
        });

        console.log('Update result:', result);
        showNotification('User updated successfully!', 'success');
        loadUsers();
      closeEdit();
      } catch (error) {
        console.error('Error updating user:', error);
        console.error('Error details:', error);
        showNotification(`Error updating user: ${error.message || 'Unknown error'}`, 'error');
      }
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : type === 'error' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Load transfer requests
    async function loadTransferRequests() {
      try {
        const transfers = await apiCall('/transfers') || [];
        renderTransferRequests(transfers);
        updateTransferStats(transfers);
      } catch (error) {
        console.error('Error loading transfers:', error);
        showNotification('Error loading transfer requests', 'error');
      }
    }

    // Render transfer requests
    function renderTransferRequests(transfers) {
      const container = document.getElementById('transferRequests');
      if (!container) return;

      if (transfers.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">No transfer requests found.</div>';
        return;
      }

      container.innerHTML = '';
      
      transfers.forEach(transfer => {
        const transferElement = document.createElement('div');
        transferElement.className = `border rounded p-4 ${transfer.status === 'pending' ? 'bg-yellow-50' : transfer.status === 'completed' ? 'bg-green-50' : 'bg-red-50'}`;
        
        const statusColor = transfer.status === 'pending' ? 'text-yellow-600' : transfer.status === 'completed' ? 'text-green-600' : 'text-red-600';
        const statusBg = transfer.status === 'pending' ? 'bg-yellow-100' : transfer.status === 'completed' ? 'bg-green-100' : 'bg-red-100';
        
      transferElement.innerHTML = `
        <div class="flex justify-between items-start">
            <div class="flex-1">
              <h3 class="font-semibold">Transfer Request #${transfer.transferId || `TRX-${transfer.id}`}</h3>
              <p class="text-sm text-gray-600">From: ${transfer.fromUser ? transfer.fromUser.name : 'Unknown'} (•••• ${transfer.fromUser ? transfer.fromUser.account.slice(-4) : '****'})</p>
              ${transfer.type === 'internal' && transfer.toUser ? 
                `<p class="text-sm text-gray-600">To: ${transfer.toUser.name} (•••• ${transfer.toUser.account.slice(-4)})</p>` : 
                transfer.type === 'external' ? 
                `<p class="text-sm text-gray-600">To: ${transfer.bankName} (External Transfer)</p>` : 
                '<p class="text-sm text-gray-600">To: External Account</p>'
              }
              <p class="text-sm text-gray-600">Amount: $${transfer.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
              <p class="text-sm text-gray-600">Date: ${transfer.date} ${transfer.time}</p>
              ${transfer.memo ? `<p class="text-sm text-gray-600">Memo: ${transfer.memo}</p>` : ''}
              <span class="inline-block px-2 py-1 rounded text-xs ${statusBg} ${statusColor} font-semibold">${transfer.status.charAt(0).toUpperCase() + transfer.status.slice(1)}</span>
          </div>
            <div class="flex space-x-2 ml-4">
              ${transfer.status === 'pending' ? `
                <button onclick="approveTransfer(${transfer.id})" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">Approve</button>
                <button onclick="rejectTransfer(${transfer.id})" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Reject</button>
              ` : `
                <span class="text-sm ${statusColor} font-semibold">${transfer.status === 'completed' ? '✓ Approved' : '✗ Rejected'}</span>
              `}
            </div>
        </div>
      `;
      
        container.appendChild(transferElement);
      });
    }

    // Update transfer statistics
    function updateTransferStats(transfers) {
      const statsElement = document.getElementById('transferStats');
      if (!statsElement) return;

      const pending = transfers.filter(t => t.status === 'pending').length;
      const completed = transfers.filter(t => t.status === 'completed').length;
      const rejected = transfers.filter(t => t.status === 'rejected').length;
      const total = transfers.length;

      statsElement.textContent = `${total} total • ${pending} pending • ${completed} completed • ${rejected} rejected`;
    }

    // Approve transfer
    async function approveTransfer(transferId) {
      if (!confirm('Are you sure you want to approve this transfer?')) return;
      
      try {
        const result = await apiCall(`/transfers/${transferId}/approve`, { method: 'PUT' });
        if (result.success) {
          showNotification('Transfer approved successfully!', 'success');
          loadTransferRequests();
          loadUsers(); // Refresh user balances
        } else {
          showNotification('Failed to approve transfer', 'error');
        }
      } catch (error) {
        console.error('Error approving transfer:', error);
        showNotification('Error approving transfer', 'error');
      }
    }

    // Reject transfer
    async function rejectTransfer(transferId) {
      if (!confirm('Are you sure you want to reject this transfer?')) return;
      
      try {
        const result = await apiCall(`/transfers/${transferId}/reject`, { method: 'PUT' });
        if (result.success) {
          showNotification('Transfer rejected successfully!', 'success');
          loadTransferRequests();
        } else {
          showNotification('Failed to reject transfer', 'error');
        }
      } catch (error) {
        console.error('Error rejecting transfer:', error);
        showNotification('Error rejecting transfer', 'error');
      }
    }

    // Export transfers
    async function exportTransfers() {
      try {
        const transfers = await apiCall('/transfers') || [];
        const csv = 'Transfer ID,From,To,Amount,Status,Date,Type,Memo\n' +
          transfers.map(t => 
            `${t.transferId || t.id},${t.fromUser ? t.fromUser.name : 'Unknown'},${t.toUser ? t.toUser.name : t.bankName || 'External'},${t.amount},${t.status},${t.date},${t.type},${t.memo || ''}`
          ).join('\n');
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'transfers.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showNotification('Transfers exported successfully!', 'success');
      } catch (error) {
        console.error('Error exporting transfers:', error);
        showNotification('Error exporting transfers', 'error');
      }
    }

    // Simulate incoming chat messages (in real app, this would be WebSocket)
    function simulateIncomingMessage() {
      if (!chatActive) return;
      
      const messages = [
        "I have a question about my transfer status.",
        "How long will the transfer take to complete?",
        "Can I cancel the transfer?",
        "Is there a fee for this transfer?",
        "Thank you for your help!"
      ];
      
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];
      const chatBox = document.getElementById('chatBox');
      const msgHTML = `<div class="mb-2 text-left text-gray-800"><span class="bg-gray-100 px-3 py-2 rounded inline-block"><strong>User:</strong> ${randomMessage}</span></div>`;
      chatBox.innerHTML += msgHTML;
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // --- Chat Management (Socket.io + Backend API) ---
    let socket;
    let activeChats = new Map(); // Store active chat sessions

    // Initialize Socket.io connection
    function initializeSocket() {
      const admin = getAdminInfo();
      if (!admin) return;

      // Connect to Socket.io server
      const backendUrl = window.location.hostname === 'localhost' ? 'http://localhost:4000' : 'https://trial-1-sq1y.onrender.com';
      socket = io(backendUrl, {
        auth: {
          token: localStorage.getItem('jwtToken')
        }
      });

      // Join admin room
      socket.emit('join', { userId: 'admin' });

      // Listen for chat notifications
      socket.on('chatNotification', (notification) => {
        console.log('Admin received chat notification:', notification);
        handleChatNotification(notification);
      });

      // Listen for incoming messages
      socket.on('message', (message) => {
        console.log('Admin received message:', message);
        handleIncomingMessage(message);
      });

      // Listen for connection status
      socket.on('connect', () => {
        console.log('Admin connected to chat server');
      });

      socket.on('disconnect', () => {
        console.log('Admin disconnected from chat server');
      });

      socket.on('connect_error', (error) => {
        console.error('Connection error:', error);
        console.log('Falling back to localStorage chat');
      });
    }

    // Handle chat notifications from users
    function handleChatNotification(notification) {
      console.log('Handling chat notification:', notification);
      const { type, userId, userName, userAccount, transferId, timestamp } = notification;
      
      // Add to active chats
      activeChats.set(userId, {
        type,
        userName,
        userAccount,
        transferId,
        timestamp,
        messages: []
      });

      console.log('Active chats after adding:', activeChats);

      // Update display
      updateActiveChatsDisplay();

      // Show notification
      const chatBox = document.getElementById('chatBox');
      const msgHTML = `<div class="mb-2 text-left text-blue-800"><span class="bg-blue-100 px-3 py-2 rounded inline-block"><strong>System:</strong> New ${type} chat session started by ${userName}.</span></div>`;
      chatBox.innerHTML += msgHTML;
      chatBox.scrollTop = chatBox.scrollHeight;

      // Show notification indicator
      document.getElementById('chatNotification').classList.remove('hidden');
      
      // Show type-specific indicator
      const indicatorMap = {
        'signup': 'signupChatIndicator',
        'dashboard': 'dashboardChatIndicator',
        'livechat': 'liveChatIndicator',
        'transfer': 'transferChatIndicator'
      };
      
      const indicatorId = indicatorMap[type];
      if (indicatorId) {
        document.getElementById(indicatorId).classList.remove('hidden');
      }
    }

    // Handle incoming messages
    function handleIncomingMessage(message) {
      console.log('Handling incoming message:', message);
      const { from, content, timestamp } = message;
      
      // Add message to active chat
      if (activeChats.has(from)) {
        const chat = activeChats.get(from);
        chat.messages.push({
          from: 'user',
          content,
          timestamp
        });
        activeChats.set(from, chat);
        console.log('Updated active chat for user:', from);
      } else {
        console.log('No active chat found for user:', from);
      }

      // Display message in chat box
      const chatBox = document.getElementById('chatBox');
      const msgHTML = `<div class="mb-2 text-left text-gray-800"><span class="bg-gray-100 px-3 py-2 rounded inline-block"><strong>User:</strong> ${content}</span></div>`;
      chatBox.innerHTML += msgHTML;
      chatBox.scrollTop = chatBox.scrollHeight;

      // Show notification
      document.getElementById('chatNotification').classList.remove('hidden');
    }

    // Update active chats display
    function updateActiveChatsDisplay() {
      const activeChatsDiv = document.getElementById('activeChats');
      if (!activeChatsDiv) return;
      
      if (activeChats.size === 0) {
        activeChatsDiv.innerHTML = '<p class="text-sm text-gray-500">No active chat sessions</p>';
        return;
      }
      
      const chatList = Array.from(activeChats.entries()).map(([userId, chat]) => {
        const colorMap = {
          'signup': 'blue',
          'dashboard': 'green',
          'livechat': 'purple',
          'transfer': 'orange'
        };
        const color = colorMap[chat.type] || 'gray';
        
        return `
          <div class="flex items-center justify-between p-2 bg-${color}-50 border border-${color}-200 rounded">
            <div>
              <span class="text-sm font-medium text-${color}-800">${chat.type.toUpperCase()} Chat</span>
              <div class="text-xs text-gray-500">${chat.userName} (${chat.userAccount})</div>
              ${chat.transferId ? `<div class="text-xs text-gray-400">Transfer: ${chat.transferId}</div>` : ''}
            </div>
            <span class="text-xs text-gray-500">${new Date(chat.timestamp).toLocaleTimeString()}</span>
          </div>
        `;
      }).join('');
      
      activeChatsDiv.innerHTML = chatList;
    }

    // Check for all chat messages from different sources (fallback)
    function checkForAllChatMessages() {
      // Check sign-up messages
      checkForSignupMessages();
      
      // Check dashboard messages
      checkForDashboardMessages();
      
      // Check live chat messages
      checkForLiveChatMessages();
      
      // Check transfer chat messages
      checkForTransferChatMessages();
    }

    // Check for sign-up chat messages
    function checkForSignupMessages() {
      const newSignupMessage = localStorage.getItem('newSignupMessage');
      const newSignupChat = localStorage.getItem('newSignupChat');
      
      if (newSignupChat === 'true') {
        // New sign-up chat session started
        const chatSession = JSON.parse(localStorage.getItem('currentSignupChat'));
        const chatBox = document.getElementById('chatBox');
        const msgHTML = `<div class="mb-2 text-left text-blue-800"><span class="bg-blue-100 px-3 py-2 rounded inline-block"><strong>System:</strong> New sign-up chat session started from sign-up page.</span></div>`;
        chatBox.innerHTML += msgHTML;
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // Show notification and indicator
        document.getElementById('chatNotification').classList.remove('hidden');
        document.getElementById('signupChatIndicator').classList.remove('hidden');
        chatActive = true;
        
        localStorage.removeItem('newSignupChat');
      }
      
      if (newSignupMessage === 'true') {
        // New message from sign-up page
        const signupMessages = JSON.parse(localStorage.getItem('signupChatMessages') || '[]');
        if (signupMessages.length > 0) {
          const latestMessage = signupMessages[signupMessages.length - 1];
          const chatBox = document.getElementById('chatBox');
          const msgHTML = `<div class="mb-2 text-left text-gray-800"><span class="bg-gray-100 px-3 py-2 rounded inline-block"><strong>Sign-up User:</strong> ${latestMessage.message}</span></div>`;
          chatBox.innerHTML += msgHTML;
          chatBox.scrollTop = chatBox.scrollHeight;
          
          // Show notification and indicator
          document.getElementById('chatNotification').classList.remove('hidden');
          document.getElementById('signupChatIndicator').classList.remove('hidden');
          chatActive = true;
        }
        
        localStorage.removeItem('newSignupMessage');
      }
    }

    // Check for dashboard chat messages
    function checkForDashboardMessages() {
      const newDashboardMessage = localStorage.getItem('newDashboardMessage');
      const newDashboardChat = localStorage.getItem('newDashboardChat');
      
      if (newDashboardChat === 'true') {
        // New dashboard chat session started
        const chatSession = JSON.parse(localStorage.getItem('currentDashboardChat'));
        const chatBox = document.getElementById('chatBox');
        const msgHTML = `<div class="mb-2 text-left text-green-800"><span class="bg-green-100 px-3 py-2 rounded inline-block"><strong>System:</strong> New dashboard chat session started.</span></div>`;
        chatBox.innerHTML += msgHTML;
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // Show notification and indicator
        document.getElementById('chatNotification').classList.remove('hidden');
        document.getElementById('dashboardChatIndicator').classList.remove('hidden');
        chatActive = true;
        
        localStorage.removeItem('newDashboardChat');
      }
      
      if (newDashboardMessage === 'true') {
        // New message from dashboard
        const dashboardMessages = JSON.parse(localStorage.getItem('dashboardChatMessages') || '[]');
        if (dashboardMessages.length > 0) {
          const latestMessage = dashboardMessages[dashboardMessages.length - 1];
          const chatBox = document.getElementById('chatBox');
          const msgHTML = `<div class="mb-2 text-left text-gray-800"><span class="bg-gray-100 px-3 py-2 rounded inline-block"><strong>Dashboard User:</strong> ${latestMessage.message}</span></div>`;
          chatBox.innerHTML += msgHTML;
          chatBox.scrollTop = chatBox.scrollHeight;
          
          // Show notification and indicator
          document.getElementById('chatNotification').classList.remove('hidden');
          document.getElementById('dashboardChatIndicator').classList.remove('hidden');
          chatActive = true;
        }
        
        localStorage.removeItem('newDashboardMessage');
      }
    }

    // Check for live chat messages
    function checkForLiveChatMessages() {
      const newLiveChatMessage = localStorage.getItem('newLiveChatMessage');
      const newLiveChat = localStorage.getItem('newLiveChat');
      
      if (newLiveChat === 'true') {
        // New live chat session started
        const chatSession = JSON.parse(localStorage.getItem('currentLiveChat'));
        const chatBox = document.getElementById('chatBox');
        const msgHTML = `<div class="mb-2 text-left text-purple-800"><span class="bg-purple-100 px-3 py-2 rounded inline-block"><strong>System:</strong> New live chat session started.</span></div>`;
        chatBox.innerHTML += msgHTML;
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // Show notification and indicator
        document.getElementById('chatNotification').classList.remove('hidden');
        document.getElementById('liveChatIndicator').classList.remove('hidden');
        chatActive = true;
        
        localStorage.removeItem('newLiveChat');
      }
      
      if (newLiveChatMessage === 'true') {
        // New message from live chat
        const liveChatMessages = JSON.parse(localStorage.getItem('liveChatMessages') || '[]');
        if (liveChatMessages.length > 0) {
          const latestMessage = liveChatMessages[liveChatMessages.length - 1];
          const chatBox = document.getElementById('chatBox');
          const msgHTML = `<div class="mb-2 text-left text-gray-800"><span class="bg-gray-100 px-3 py-2 rounded inline-block"><strong>Live Chat User:</strong> ${latestMessage.message}</span></div>`;
          chatBox.innerHTML += msgHTML;
          chatBox.scrollTop = chatBox.scrollHeight;
          
          // Show notification and indicator
          document.getElementById('chatNotification').classList.remove('hidden');
          document.getElementById('liveChatIndicator').classList.remove('hidden');
          chatActive = true;
        }
        
        localStorage.removeItem('newLiveChatMessage');
      }
    }

    // Check for transfer chat messages
    function checkForTransferChatMessages() {
      const newTransferMessage = localStorage.getItem('newTransferMessage');
      const newTransferChat = localStorage.getItem('newTransferChat');
      
      if (newTransferChat === 'true') {
        // New transfer chat session started
        const chatSession = JSON.parse(localStorage.getItem('currentTransferChat'));
        const chatBox = document.getElementById('chatBox');
        const msgHTML = `<div class="mb-2 text-left text-orange-800"><span class="bg-orange-100 px-3 py-2 rounded inline-block"><strong>System:</strong> New transfer chat session started.</span></div>`;
        chatBox.innerHTML += msgHTML;
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // Show notification and indicator
        document.getElementById('chatNotification').classList.remove('hidden');
        document.getElementById('transferChatIndicator').classList.remove('hidden');
        chatActive = true;
        
        localStorage.removeItem('newTransferChat');
      }
      
      if (newTransferMessage === 'true') {
        // New message from transfer chat
        const transferMessages = JSON.parse(localStorage.getItem('transferChatMessages') || '[]');
        if (transferMessages.length > 0) {
          const latestMessage = transferMessages[transferMessages.length - 1];
          const chatBox = document.getElementById('chatBox');
          const msgHTML = `<div class="mb-2 text-left text-gray-800"><span class="bg-gray-100 px-3 py-2 rounded inline-block"><strong>Transfer User:</strong> ${latestMessage.message}</span></div>`;
          chatBox.innerHTML += msgHTML;
          chatBox.scrollTop = chatBox.scrollHeight;
          
          // Show notification and indicator
          document.getElementById('chatNotification').classList.remove('hidden');
          document.getElementById('transferChatIndicator').classList.remove('hidden');
          chatActive = true;
        }
        
        localStorage.removeItem('newTransferMessage');
      }
    }

    // Enhanced send message function to handle all chat sources
    function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;
      
      const chatBox = document.getElementById('chatBox');
      const msgHTML = `<div class="mb-2 text-right text-indigo-800"><span class="bg-indigo-100 px-3 py-2 rounded inline-block"><strong>Admin:</strong> ${message}</span></div>`;
      chatBox.innerHTML += msgHTML;
      
      // Send message to all active chat sessions via Socket.io
      if (socket && socket.connected) {
        console.log('Sending message via Socket.io to active chats:', activeChats);
        activeChats.forEach((chat, userId) => {
          const messageData = {
            from: 'admin',
            to: userId,
            content: message,
            timestamp: new Date().toISOString()
          };
          console.log('Sending message:', messageData);
          socket.emit('message', messageData);
        });
      } else {
        console.log('Socket.io not connected, using localStorage fallback');
        // Fallback to localStorage
        const response = {
          message: message,
          timestamp: new Date().toISOString()
        };
        
        if (localStorage.getItem('currentSignupChat')) localStorage.setItem('adminResponseToSignup', JSON.stringify(response));
        if (localStorage.getItem('currentDashboardChat')) localStorage.setItem('adminResponseToDashboard', JSON.stringify(response));
        if (localStorage.getItem('currentLiveChat')) localStorage.setItem('adminResponseToLiveChat', JSON.stringify(response));
        if (localStorage.getItem('currentTransferChat')) localStorage.setItem('adminResponseToTransferChat', JSON.stringify(response));
      }
      
      input.value = '';
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Test functions for chat
    function testSignupChat() {
      const chatBox = document.getElementById('chatBox');
      const msgHTML = `<div class="mb-2 text-left text-blue-800"><span class="bg-blue-100 px-3 py-2 rounded inline-block"><strong>System:</strong> Simulating new sign-up chat session.</span></div>`;
      chatBox.innerHTML += msgHTML;
      chatBox.scrollTop = chatBox.scrollHeight;

      document.getElementById('signupChatIndicator').classList.remove('hidden');
      localStorage.setItem('newSignupChat', 'true');
      localStorage.setItem('currentSignupChat', JSON.stringify({
        userId: 'testUser123',
        userName: 'Test User',
        userEmail: 'test@example.com',
        timestamp: new Date().toISOString()
      }));
      localStorage.setItem('signupChatMessages', JSON.stringify([
        { message: 'Hello! I just signed up for an account.', timestamp: new Date().toISOString() },
        { message: 'How can I help you today?', timestamp: new Date().toISOString() }
      ]));
      localStorage.setItem('newSignupMessage', 'true');
      chatActive = true;
    }

    function testDashboardChat() {
      const chatBox = document.getElementById('chatBox');
      const msgHTML = `<div class="mb-2 text-left text-green-800"><span class="bg-green-100 px-3 py-2 rounded inline-block"><strong>System:</strong> Simulating new dashboard chat session.</span></div>`;
      chatBox.innerHTML += msgHTML;
      chatBox.scrollTop = chatBox.scrollHeight;

      document.getElementById('dashboardChatIndicator').classList.remove('hidden');
      localStorage.setItem('newDashboardChat', 'true');
      localStorage.setItem('currentDashboardChat', JSON.stringify({
        userId: 'testUser456',
        userName: 'Test Dashboard User',
        userEmail: 'dashboard@example.com',
        timestamp: new Date().toISOString()
      }));
      localStorage.setItem('dashboardChatMessages', JSON.stringify([
        { message: 'Hello from the dashboard!', timestamp: new Date().toISOString() },
        { message: 'How can I assist you?', timestamp: new Date().toISOString() }
      ]));
      localStorage.setItem('newDashboardMessage', 'true');
      chatActive = true;
    }

    function testLiveChat() {
      const chatBox = document.getElementById('chatBox');
      const msgHTML = `<div class="mb-2 text-left text-purple-800"><span class="bg-purple-100 px-3 py-2 rounded inline-block"><strong>System:</strong> Simulating new live chat session.</span></div>`;
      chatBox.innerHTML += msgHTML;
      chatBox.scrollTop = chatBox.scrollHeight;

      document.getElementById('liveChatIndicator').classList.remove('hidden');
      localStorage.setItem('newLiveChat', 'true');
      localStorage.setItem('currentLiveChat', JSON.stringify({
        userId: 'testUser789',
        userName: 'Test Live User',
        userEmail: 'live@example.com',
        timestamp: new Date().toISOString()
      }));
      localStorage.setItem('liveChatMessages', JSON.stringify([
        { message: 'Hello from the live chat!', timestamp: new Date().toISOString() },
        { message: 'How can I help you?', timestamp: new Date().toISOString() }
      ]));
      localStorage.setItem('newLiveChatMessage', 'true');
      chatActive = true;
    }

    function testTransferChat() {
      const chatBox = document.getElementById('chatBox');
      const msgHTML = `<div class="mb-2 text-left text-orange-800"><span class="bg-orange-100 px-3 py-2 rounded inline-block"><strong>System:</strong> Simulating new transfer chat session.</span></div>`;
      chatBox.innerHTML += msgHTML;
      chatBox.scrollTop = chatBox.scrollHeight;

      document.getElementById('transferChatIndicator').classList.remove('hidden');
      localStorage.setItem('newTransferChat', 'true');
      localStorage.setItem('currentTransferChat', JSON.stringify({
        userId: 'testUser101',
        userName: 'Test Transfer User',
        userEmail: 'transfer@example.com',
        timestamp: new Date().toISOString()
      }));
      localStorage.setItem('transferChatMessages', JSON.stringify([
        { message: 'Hello from the transfer chat!', timestamp: new Date().toISOString() },
        { message: 'How can I help you?', timestamp: new Date().toISOString() }
      ]));
      localStorage.setItem('newTransferMessage', 'true');
      chatActive = true;
    }

    // Function to clear all chat sessions
    function clearAllChatSessions() {
      localStorage.removeItem('currentSignupChat');
      localStorage.removeItem('currentDashboardChat');
      localStorage.removeItem('currentLiveChat');
      localStorage.removeItem('currentTransferChat');
      localStorage.removeItem('signupChatMessages');
      localStorage.removeItem('dashboardChatMessages');
      localStorage.removeItem('liveChatMessages');
      localStorage.removeItem('transferChatMessages');
      
      // Hide all indicators
      document.getElementById('signupChatIndicator').classList.add('hidden');
      document.getElementById('dashboardChatIndicator').classList.add('hidden');
      document.getElementById('liveChatIndicator').classList.add('hidden');
      document.getElementById('transferChatIndicator').classList.add('hidden');
      
      // Update display
      updateActiveChatsDisplay();
    }

    // Add clear button to the interface
    document.addEventListener('DOMContentLoaded', function() {
      const clearButton = document.createElement('button');
      clearButton.textContent = 'Clear All Chats';
      clearButton.className = 'bg-red-500 text-white px-3 py-1 rounded text-sm';
      clearButton.onclick = clearAllChatSessions;
      
      const buttonContainer = document.querySelector('.mb-4.flex.space-x-2');
      if (buttonContainer) {
        buttonContainer.appendChild(clearButton);
      }
    });

    // --- Transaction Management (Backend API) ---
    async function renderTransactions(txList) {
      const tbody = document.getElementById('transactionTable');
      const noTxMessage = document.getElementById('noTxMessage');
      if (!tbody) return;
      if (!txList || txList.length === 0) {
        tbody.innerHTML = '';
        if (noTxMessage) noTxMessage.classList.remove('hidden');
        return;
      }
      if (noTxMessage) noTxMessage.classList.add('hidden');
      tbody.innerHTML = '';
      txList.forEach((tx) => {
        tbody.innerHTML += `
          <tr>
            <td class="p-2 font-mono">${tx.user ? tx.user.account : 'N/A'}</td>
            <td class="p-2">${tx.date}</td>
            <td class="p-2">${tx.time}</td>
            <td class="p-2">${tx.description}</td>
            <td class="p-2">${tx.category}</td>
            <td class="p-2 font-bold ${tx.amount < 0 ? 'text-red-600' : 'text-green-600'}">${tx.amount < 0 ? '-' : '+'}$${Math.abs(tx.amount).toLocaleString('en-US', {minimumFractionDigits:2})}</td>
            <td class="p-2"><span class="px-2 py-1 rounded text-xs ${tx.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${tx.status.charAt(0).toUpperCase() + tx.status.slice(1)}</span></td>
            <td class="p-2">
                              <button onclick="editTransaction('${tx.id}')" class="text-indigo-600 hover:underline mr-2">Edit</button>
                <button onclick="deleteTransaction('${tx.id}')" class="text-red-600 hover:underline">Delete</button>
            </td>
          </tr>
        `;
      });
    }

    // Add transaction
    document.getElementById('addTransactionForm').onsubmit = async function(e) {
      e.preventDefault();
      const tx = {
        userAccount: document.getElementById('txUserAccount').value.trim(),
        date: document.getElementById('txDate').value,
        time: document.getElementById('txTime').value,
        description: document.getElementById('txDescription').value.trim(),
        category: document.getElementById('txCategory').value.trim(),
        amount: parseFloat(document.getElementById('txAmount').value),
        status: document.getElementById('txStatus').value
      };
      if (!tx.userAccount || !tx.date || !tx.time || !tx.description || !tx.category || isNaN(tx.amount)) {
        alert('Please fill all fields.');
        return;
      }

      try {
        // Find user by account number
        const user = users.find(u => u.account === tx.userAccount);
        if (!user) {
          alert('User account not found.');
          return;
        }

        await apiCall('/transactions', {
          method: 'POST',
          body: JSON.stringify({
            user: user.id,
            date: tx.date,
            time: tx.time,
            description: tx.description,
            category: tx.category,
            amount: tx.amount,
            status: tx.status
          })
        });

        showNotification('Transaction added!', 'success');
        loadTransactions();
        this.reset();
      } catch (error) {
        console.error('Error adding transaction:', error);
        showNotification('Error adding transaction', 'error');
      }
    };

    // Edit transaction
    async function editTransaction(id) {
      try {
        const transactions = await apiCall('/transactions');
        const tx = transactions.find(t => t.id === id);
        if (!tx) return;

        // Fill form with tx data
        document.getElementById('txUserAccount').value = tx.user ? tx.user.account : '';
        document.getElementById('txDate').value = tx.date;
        document.getElementById('txTime').value = tx.time;
        document.getElementById('txDescription').value = tx.description;
        document.getElementById('txCategory').value = tx.category;
        document.getElementById('txAmount').value = tx.amount;
        document.getElementById('txStatus').value = tx.status;
      } catch (error) {
        console.error('Error loading transaction for edit:', error);
      }
    }

    // Delete transaction
    async function deleteTransaction(id) {
      if (!confirm('Delete this transaction?')) return;
      
      try {
        await apiCall(`/transactions/${id}`, { method: 'DELETE' });
        showNotification('Transaction deleted!', 'success');
        loadTransactions();
      } catch (error) {
        console.error('Error deleting transaction:', error);
        showNotification('Error deleting transaction', 'error');
      }
    }

    // Filter transactions
    function filterTransactions() {
      const q = document.getElementById('txSearch').value.toLowerCase();
      // This would need to be implemented on the backend for better performance
      // For now, we'll filter client-side
      loadTransactions().then(transactions => {
        const filtered = transactions.filter(tx =>
          (tx.user && tx.user.account && tx.user.account.toLowerCase().includes(q)) ||
          (tx.description && tx.description.toLowerCase().includes(q)) ||
          (tx.category && tx.category.toLowerCase().includes(q))
        );
        renderTransactions(filtered);
      });
    }

    // Export transactions
    async function exportTransactions() {
      try {
        const txs = await apiCall('/transactions');
        const csv = 'Account,Date,Time,Description,Category,Amount,Status\n' +
          txs.map(tx => `${tx.user ? tx.user.account : 'N/A'},${tx.date},${tx.time},${tx.description},${tx.category},${tx.amount},${tx.status}`).join('\n');
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'transactions.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showNotification('Transactions exported!', 'success');
      } catch (error) {
        console.error('Error exporting transactions:', error);
        showNotification('Error exporting transactions', 'error');
      }
    }

    // Update user statistics
    function updateUserStatistics() {
      const totalUsers = users.length;
      const totalBalance = users.reduce((sum, user) => sum + (user.balance || 0), 0);
      const avgBalance = totalUsers > 0 ? totalBalance / totalUsers : 0;
      const highBalanceUsers = users.filter(user => (user.balance || 0) > 10000).length;

      const totalUsersEl = document.getElementById('totalUsers');
      const totalBalanceEl = document.getElementById('totalBalance');
      const avgBalanceEl = document.getElementById('avgBalance');
      const highBalanceUsersEl = document.getElementById('highBalanceUsers');

      if (totalUsersEl) totalUsersEl.textContent = totalUsers;
      if (totalBalanceEl) totalBalanceEl.textContent = `$${totalBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      if (avgBalanceEl) avgBalanceEl.textContent = `$${avgBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      if (highBalanceUsersEl) highBalanceUsersEl.textContent = highBalanceUsers;
    }

    // Search and filter functionality
    function filterUsers() {
      const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
      const filteredUsers = users.filter(user => 
        user.name.toLowerCase().includes(searchTerm) ||
        user.email.toLowerCase().includes(searchTerm) ||
        user.account.includes(searchTerm)
      );
      renderUsers(filteredUsers);
    }

    function sortUsers() {
      const sortBy = document.getElementById('sortUsers').value;
      const sortedUsers = [...users].sort((a, b) => {
        switch(sortBy) {
          case 'name':
            return a.name.localeCompare(b.name);
          case 'balance':
            return (b.balance || 0) - (a.balance || 0); // High to low
          case 'account':
            return a.account.localeCompare(b.account);
          default:
            return 0;
        }
      });
      renderUsers(sortedUsers);
    }

    async function exportUsers() {
      const csvContent = "data:text/csv;charset=utf-8," 
        + "Name,Email,Account,Balance\n"
        + users.map(user => 
            `"${user.name}","${user.email}","${user.account}","${user.balance || 0}"`
          ).join("\n");
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "users_export.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showNotification('Users exported successfully!', 'success');
    }

    // Admin session management
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('jwtToken');
        localStorage.removeItem('userInfo');
        window.location.href = 'login.html';
      }
    }

    // Mobile menu functionality
    function initializeMobileMenu() {
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const closeSidebar = document.getElementById('closeSidebar');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileMenuOverlay');

      function openSidebar() {
        sidebar.classList.add('active');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeSidebarMenu() {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      mobileMenuToggle.addEventListener('click', openSidebar);
      closeSidebar.addEventListener('click', closeSidebarMenu);
      overlay.addEventListener('click', closeSidebarMenu);

      // Close sidebar when clicking on navigation links
      const navLinks = sidebar.querySelectorAll('a');
      navLinks.forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth <= 768) {
            closeSidebarMenu();
          }
        });
      });
    }

    // Update renderUsers function to support mobile cards
    function renderUsers(userList = users) {
      const tbody = document.getElementById('userTable');
      const userCards = document.getElementById('userCards');
      const noUsersMessage = document.getElementById('noUsersMessage');

      if (!tbody || !userCards) return;

      // Clear existing content
      tbody.innerHTML = '';
      userCards.innerHTML = '';

      if (!userList || userList.length === 0) {
        noUsersMessage.classList.remove('hidden');
        return;
      }

      noUsersMessage.classList.add('hidden');

      userList.forEach(user => {
        // Desktop table row
        const row = `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-3">
              <img src="${user.profilePicture || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=4F46E5&color=fff&size=40`}" 
                   class="h-10 w-10 rounded-full" alt="${user.name}" />
            </td>
            <td class="p-3 font-medium">${user.name}</td>
            <td class="p-3 text-gray-600">${user.email}</td>
            <td class="p-3 text-gray-600">${user.account}</td>
            <td class="p-3 font-medium">$${(user.balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td class="p-3">
              <div class="flex space-x-2">
                <button onclick="openEdit('${user.id}')" class="text-indigo-600 hover:text-indigo-800 font-medium">Edit</button>
                <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-800 font-medium">Delete</button>
              </div>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;

        // Mobile card
        const card = `
          <div class="bg-gray-50 rounded-lg p-4 border">
            <div class="flex items-center space-x-3 mb-3">
              <img src="${user.profilePicture || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=4F46E5&color=fff&size=40`}" 
                   class="h-12 w-12 rounded-full" alt="${user.name}" />
              <div class="flex-1">
                <h3 class="font-medium text-gray-900">${user.name}</h3>
                <p class="text-sm text-gray-600">${user.email}</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
              <div>
                <span class="text-gray-500">Account:</span>
                <span class="font-medium">${user.account}</span>
              </div>
              <div>
                <span class="text-gray-500">Balance:</span>
                <span class="font-medium text-green-600">$${(user.balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>
            </div>
            <div class="flex space-x-2">
              <button onclick="openEdit('${user.id}')" class="flex-1 bg-indigo-600 text-white px-3 py-2 rounded text-sm hover:bg-indigo-700 transition-colors">Edit</button>
              <button onclick="deleteUser('${user.id}')" class="flex-1 bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700 transition-colors">Delete</button>
            </div>
          </div>
        `;
        userCards.innerHTML += card;
      });
      
      updateUserStatistics();
    }

    // Initialize mobile menu on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Check if admin is logged in
      const admin = getAdminInfo();
      if (!admin) return;

      // Initialize mobile menu
      initializeMobileMenu();

      // Load data from backend
      loadUsers();
      loadTransactions();
      loadTransferRequests();
      updateActiveChatsDisplay();
      initializeSocket(); // Initialize Socket.io
      
      // Add chat input event listener
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            sendMessage();
          }
        });
      }
    });
  </script>

</body>
</html>
